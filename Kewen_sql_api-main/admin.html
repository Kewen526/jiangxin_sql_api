<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ”§ API ç®¡ç†ç³»ç»Ÿ</title>
  <style>
    /* ===== CSS Variables (VS Codeé£æ ¼é…è‰²) ===== */
    :root {
      --bg-primary: #1e1e1e;
      --bg-secondary: #252526;
      --bg-tertiary: #2d2d30;
      --bg-hover: #2a2d2e;
      --border-color: #3e3e42;
      --text-primary: #cccccc;
      --text-secondary: #969696;
      --accent-blue: #007acc;
      --accent-light: #4fc3f7;
      --accent-success: #4caf50;
      --accent-warning: #ff9800;
      --accent-danger: #f44336;
      --shadow: 0 2px 8px rgba(0,0,0,0.3);
    }

    /* ===== å…¨å±€æ ·å¼ ===== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Consolas', 'Monaco', 'Courier New', monospace, 'Microsoft YaHei', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      height: 100vh;
      overflow: hidden;
    }

    /* ===== é¡¶éƒ¨å¯¼èˆªæ  ===== */
    .header {
      height: 50px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .logo {
      font-size: 18px;
      font-weight: 600;
      color: var(--accent-light);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .header-stats {
      display: flex;
      gap: 20px;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .stat-item {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .stat-value {
      color: var(--accent-light);
      font-weight: 600;
    }

    .header-actions {
      display: flex;
      gap: 10px;
    }

    /* ===== ä¸»ä½“å¸ƒå±€ ===== */
    .main-container {
      display: flex;
      height: calc(100vh - 50px);
      overflow: hidden;
    }

    /* ===== å·¦ä¾§è¾¹æ  ===== */
    .sidebar {
      width: 300px;
      background: var(--bg-secondary);
      border-right: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .sidebar-header {
      padding: 15px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .sidebar-title {
      font-size: 12px;
      text-transform: uppercase;
      color: var(--text-secondary);
      letter-spacing: 1px;
    }

    .sidebar-content {
      flex: 1;
      overflow-y: auto;
      padding: 10px 0;
    }

    /* ===== æ ‘å½¢èœå• ===== */
    .tree-group {
      margin-bottom: 5px;
    }

    .group-header {
      padding: 8px 15px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: background 0.2s;
      user-select: none;
    }

    .group-header:hover {
      background: var(--bg-hover);
    }

    .group-icon {
      font-size: 14px;
      transition: transform 0.2s;
    }

    .group-header.collapsed .group-icon {
      transform: rotate(-90deg);
    }

    .group-name {
      flex: 1;
      font-size: 14px;
      color: var(--text-primary);
    }

    .group-count {
      font-size: 11px;
      color: var(--text-secondary);
      background: var(--bg-tertiary);
      padding: 2px 6px;
      border-radius: 10px;
    }

    .group-apis {
      display: none;
      padding-left: 25px;
    }

    .group-apis.expanded {
      display: block;
    }

    .api-item {
      padding: 6px 15px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--text-secondary);
      transition: all 0.2s;
      border-left: 2px solid transparent;
    }

    .api-item:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .api-item.active {
      background: var(--bg-tertiary);
      color: var(--accent-light);
      border-left-color: var(--accent-blue);
    }

    .api-method {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 3px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .api-method.post {
      background: #4caf5020;
      color: #4caf50;
    }

    .api-method.get {
      background: #2196f320;
      color: #2196f3;
    }

    .api-method.put {
      background: #ff980020;
      color: #ff9800;
    }

    .api-method.delete {
      background: #f4433620;
      color: #f44336;
    }

    /* ===== å³ä¾§ä¸»é¢æ¿ ===== */
    .main-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      background: var(--bg-primary);
    }

    /* ===== æ¬¢è¿é¡µ ===== */
    .welcome-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      text-align: center;
      padding: 40px;
    }

    .welcome-icon {
      font-size: 80px;
      margin-bottom: 20px;
      opacity: 0.3;
    }

    .welcome-title {
      font-size: 24px;
      margin-bottom: 10px;
      color: var(--text-primary);
    }

    .welcome-subtitle {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 30px;
    }

    /* ===== APIè¯¦æƒ…é¢æ¿ ===== */
    .detail-panel {
      display: none;
      flex-direction: column;
      height: 100%;
    }

    .detail-panel.active {
      display: flex;
    }

    .detail-header {
      padding: 20px;
      border-bottom: 1px solid var(--border-color);
      background: var(--bg-secondary);
    }

    .detail-title {
      font-size: 18px;
      margin-bottom: 5px;
      color: var(--text-primary);
    }

    .detail-path {
      font-size: 13px;
      color: var(--accent-light);
      font-family: 'Consolas', monospace;
    }

    .detail-tabs {
      display: flex;
      gap: 2px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
    }

    .detail-tab {
      padding: 10px 20px;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
      border-bottom: 2px solid transparent;
    }

    .detail-tab:hover {
      color: var(--text-primary);
      background: var(--bg-hover);
    }

    .detail-tab.active {
      color: var(--accent-light);
      border-bottom-color: var(--accent-blue);
      background: var(--bg-primary);
    }

    .detail-content {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    .tab-pane {
      display: none;
    }

    .tab-pane.active {
      display: block;
    }

    /* ===== è¡¨å•æ ·å¼ ===== */
    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      padding: 10px 12px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      color: var(--text-primary);
      font-size: 13px;
      font-family: 'Consolas', monospace;
      transition: border-color 0.2s;
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: var(--accent-blue);
    }

    .form-textarea {
      min-height: 100px;
      font-family: 'Consolas', 'Monaco', monospace;
      resize: vertical;
    }

    .form-checkbox {
      margin-right: 8px;
    }

    /* ===== SQLæ ‡ç­¾é¡µæ ·å¼ ===== */
    .sql-tabs-container {
      margin-bottom: 15px;
    }

    .sql-tabs-header {
      display: flex;
      gap: 5px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .sql-tab {
      padding: 6px 12px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
    }

    .sql-tab:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .sql-tab.active {
      background: var(--accent-blue);
      color: white;
      border-color: var(--accent-blue);
    }

    .sql-tab-close {
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      opacity: 0.7;
    }

    .sql-tab-close:hover {
      opacity: 1;
    }

    .sql-tab-add {
      padding: 6px 12px;
      background: transparent;
      border: 1px dashed var(--border-color);
      border-radius: 4px;
      color: var(--accent-light);
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }

    .sql-tab-add:hover {
      border-color: var(--accent-blue);
      background: var(--bg-hover);
    }

    .sql-tab-content {
      display: none;
    }

    .sql-tab-content.active {
      display: block;
    }

    .sql-info {
      font-size: 11px;
      color: var(--text-secondary);
      margin-bottom: 8px;
      padding: 5px;
      background: var(--bg-tertiary);
      border-radius: 3px;
    }

    /* ===== æŒ‰é’®æ ·å¼ ===== */
    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-primary {
      background: var(--accent-blue);
      color: white;
    }

    .btn-primary:hover {
      background: #005a9e;
    }

    .btn-success {
      background: var(--accent-success);
      color: white;
    }

    .btn-success:hover {
      background: #45a049;
    }

    .btn-danger {
      background: var(--accent-danger);
      color: white;
    }

    .btn-danger:hover {
      background: #d32f2f;
    }

    .btn-secondary {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
    }

    .btn-secondary:hover {
      background: var(--bg-hover);
    }

    .btn-warning {
      background: #ff9800;
      color: #000;
      border: 1px solid #e68900;
    }

    .btn-warning:hover {
      background: #e68900;
    }

    .btn-sm {
      padding: 5px 10px;
      font-size: 12px;
    }

    .btn-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    /* ===== Modalæ ·å¼ ===== */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      max-width: 800px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow);
    }

    .modal-header {
      padding: 20px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-size: 18px;
      color: var(--text-primary);
    }

    .modal-close {
      background: transparent;
      border: none;
      color: var(--text-secondary);
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
    }

    .modal-close:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .modal-body {
      padding: 20px;
    }

    .modal-footer {
      padding: 15px 20px;
      border-top: 1px solid var(--border-color);
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    /* ===== è¡¨æ ¼æ ·å¼ ===== */
    .table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    .table th,
    .table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
      font-size: 13px;
    }

    .table th {
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      font-weight: 600;
      text-transform: uppercase;
      font-size: 11px;
      letter-spacing: 0.5px;
    }

    .table td {
      color: var(--text-primary);
    }

    .table tr:hover {
      background: var(--bg-hover);
    }

    .table .actions {
      display: flex;
      gap: 5px;
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: var(--text-secondary);
      font-size: 14px;
    }

    /* ===== æ»šåŠ¨æ¡æ ·å¼ ===== */
    ::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-primary);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--bg-tertiary);
      border-radius: 5px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--border-color);
    }

    /* ===== ä»£ç å—æ ·å¼ ===== */
    .code-block {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      padding: 15px;
      font-family: 'Consolas', monospace;
      font-size: 12px;
      overflow-x: auto;
      margin: 10px 0;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    /* ===== ç»“æœå®¹å™¨æ ·å¼ ===== */
    .result-container {
      display: none;
      margin-top: 20px;
    }

    .result-container.active {
      display: block;
    }

    /* ===== æœç´¢æ¡† ===== */
    .search-box {
      margin: 10px 15px;
      position: relative;
    }

    .search-input {
      width: 100%;
      padding: 8px 12px 8px 35px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      color: var(--text-primary);
      font-size: 13px;
    }

    .search-input:focus {
      outline: none;
      border-color: var(--accent-blue);
    }

    .search-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-secondary);
      font-size: 14px;
    }
  </style>
</head>
<body>
  <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
  <div class="header">
    <div class="header-left">
      <div class="logo">
        <span>ğŸ”§</span>
        <span>API ç®¡ç†ç³»ç»Ÿ</span>
      </div>
      <div class="header-stats">
        <div class="stat-item">
          <span>æ€»æ¥å£æ•°:</span>
          <span class="stat-value" id="totalApis">0</span>
        </div>
        <div class="stat-item">
          <span>åˆ†ç»„æ•°:</span>
          <span class="stat-value" id="totalGroups">0</span>
        </div>
        <div class="stat-item">
          <span>æ•°æ®æº:</span>
          <span class="stat-value" id="totalDatasources">0</span>
        </div>
      </div>
    </div>
    <div class="header-actions">
      <button class="btn btn-primary" onclick="createNewAPI()">+ åˆ›å»ºAPI</button>
      <button class="btn btn-secondary" onclick="manageDatasources()">æ•°æ®æº</button>
      <button class="btn btn-secondary" onclick="manageGroups()">åˆ†ç»„</button>
      <button class="btn btn-secondary" onclick="refreshData()">åˆ·æ–°</button>
      <button class="btn btn-warning" onclick="reloadConfig()" title="é‡æ–°åŠ è½½APIé…ç½®ï¼Œæ— éœ€é‡å¯æœåŠ¡">ğŸ”„ çƒ­åŠ è½½</button>
    </div>
  </div>

  <!-- ä¸»ä½“å®¹å™¨ -->
  <div class="main-container">
    <!-- å·¦ä¾§è¾¹æ  -->
    <div class="sidebar">
      <div class="sidebar-header">
        <span class="sidebar-title">API Explorer</span>
        <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 11px;" onclick="toggleAllGroups()">å…¨éƒ¨æŠ˜å </button>
      </div>

      <!-- æœç´¢æ¡† -->
      <div class="search-box">
        <span class="search-icon">ğŸ”</span>
        <input type="text" class="search-input" placeholder="æœç´¢API..." id="searchInput">
      </div>

      <!-- æ ‘å½¢èœå• -->
      <div class="sidebar-content" id="apiTree">
        <!-- åŠ¨æ€åŠ è½½åˆ†ç»„å’ŒAPI -->
      </div>
    </div>

    <!-- å³ä¾§ä¸»é¢æ¿ -->
    <div class="main-panel">
      <!-- æ¬¢è¿å±å¹• -->
      <div class="welcome-screen" id="welcomeScreen">
        <div class="welcome-icon">ğŸ‘‹</div>
        <h2 class="welcome-title">æ¬¢è¿ä½¿ç”¨ API ç®¡ç†ç³»ç»Ÿ</h2>
        <p class="welcome-subtitle">ä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªAPIå¼€å§‹ç¼–è¾‘ï¼Œæˆ–åˆ›å»ºæ–°çš„API</p>
        <div class="btn-group">
          <button class="btn btn-primary" onclick="createNewAPI()">åˆ›å»ºæ–°API</button>
          <button class="btn btn-secondary" onclick="refreshData()">åˆ·æ–°åˆ—è¡¨</button>
        </div>
      </div>

      <!-- APIè¯¦æƒ…é¢æ¿ -->
      <div class="detail-panel" id="detailPanel">
        <!-- éšè—çš„IDå­—æ®µ -->
        <input type="hidden" id="apiId">

        <div class="detail-header">
          <h2 class="detail-title" id="detailTitle">APIåç§°</h2>
          <p class="detail-path" id="detailPath">/api/path</p>
        </div>

        <div class="detail-tabs">
          <button class="detail-tab active" onclick="switchTab('basic', event)">åŸºæœ¬ä¿¡æ¯</button>
          <button class="detail-tab" onclick="switchTab('sql', event)">SQLé…ç½®</button>
          <button class="detail-tab" onclick="switchTab('params', event)">å‚æ•°</button>
          <button class="detail-tab" onclick="switchTab('test', event)">æµ‹è¯•</button>
        </div>

        <div class="detail-content">
          <!-- åŸºæœ¬ä¿¡æ¯ Tab -->
          <div class="tab-pane active" id="tab-basic">
            <div class="form-group">
              <label class="form-label">APIåç§° *</label>
              <input type="text" class="form-input" id="apiName" placeholder="è¾“å…¥APIåç§°">
            </div>
            <div class="form-group">
              <label class="form-label">è¯·æ±‚è·¯å¾„ *</label>
              <input type="text" class="form-input" id="apiPath" placeholder="/api/your-endpoint">
            </div>
            <div class="form-group">
              <label class="form-label">è¯´æ˜</label>
              <textarea class="form-textarea" id="apiNote" placeholder="APIè¯´æ˜"></textarea>
            </div>
            <div class="form-group">
              <label class="form-label">æ‰€å±åˆ†ç»„ *</label>
              <select class="form-select" id="apiGroup">
                <option value="">é€‰æ‹©åˆ†ç»„</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">æ•°æ®æº *</label>
              <select class="form-select" id="apiDatasource">
                <option value="">é€‰æ‹©æ•°æ®æº</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">è¿”å›ç±»å‹</label>
              <select class="form-select" id="apiContentType">
                <option value="application/json">JSON (application/json)</option>
                <option value="text/plain">æ–‡æœ¬ (text/plain)</option>
                <option value="text/html">HTML (text/html)</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">
                <input type="checkbox" class="form-checkbox" id="apiTransaction">
                å¯ç”¨äº‹åŠ¡ï¼ˆå¤šæ¡SQLå°†åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­æ‰§è¡Œï¼‰
              </label>
            </div>
            <div class="btn-group">
              <button class="btn btn-success" onclick="saveAPI()">ğŸ’¾ ä¿å­˜</button>
              <button class="btn btn-danger" onclick="deleteCurrentAPI()">ğŸ—‘ï¸ åˆ é™¤</button>
              <button class="btn btn-secondary" onclick="closeDetail()">å…³é—­</button>
            </div>
          </div>

          <!-- SQLé…ç½® Tab -->
          <div class="tab-pane" id="tab-sql">
            <!-- SQLå¤šæ ‡ç­¾é¡µ -->
            <div class="sql-tabs-container">
              <label class="form-label">SQLè¯­å¥ *</label>
              <div class="sql-tabs-header" id="sqlTabsHeader">
                <!-- åŠ¨æ€ç”ŸæˆSQLæ ‡ç­¾ -->
              </div>
              <div id="sqlTabsContent">
                <!-- åŠ¨æ€ç”ŸæˆSQLå†…å®¹ -->
              </div>
            </div>
          </div>

          <!-- å‚æ•° Tab -->
          <div class="tab-pane" id="tab-params">
            <div class="form-group">
              <label class="form-label">å‚æ•°å®šä¹‰</label>
              <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 10px;">
                æ¯è¡Œä¸€ä¸ªå‚æ•°ï¼Œæ ¼å¼ï¼šå‚æ•°å:ç±»å‹:è¯´æ˜<br>
                ä¾‹å¦‚ï¼šid:string:ç”¨æˆ·ID
              </p>
              <textarea class="form-textarea" id="apiParams" placeholder="id:string:ç”¨æˆ·ID&#10;name:string:ç”¨æˆ·åç§°" style="min-height: 200px;"></textarea>
            </div>
          </div>

          <!-- æµ‹è¯• Tab -->
          <div class="tab-pane" id="tab-test">
            <div class="form-group">
              <label class="form-label">æµ‹è¯•å‚æ•°ï¼ˆJSONæ ¼å¼ï¼‰</label>
              <textarea class="form-textarea" id="apiTestParams" placeholder='{"id": "1", "name": "test"}' style="min-height: 150px;"></textarea>
            </div>
            <button class="btn btn-primary" onclick="testExecuteApi()">â–¶ï¸ æ‰§è¡Œæµ‹è¯•</button>

            <div class="result-container" id="testResultContainer">
              <div class="form-group" style="margin-top: 20px;">
                <label class="form-label">æµ‹è¯•ç»“æœ</label>
                <div class="code-block" id="testResult"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- æ•°æ®æºç®¡ç†Modal -->
  <div class="modal" id="datasourceManagementModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">æ•°æ®æºç®¡ç†</h3>
        <button class="modal-close" onclick="closeDatasourceManagementModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <button class="btn btn-primary btn-sm" onclick="openAddDatasourceModal()">+ æ·»åŠ æ•°æ®æº</button>
        <table class="table">
          <thead>
            <tr>
              <th>åç§°</th>
              <th>ä¸»æœº</th>
              <th>ç«¯å£</th>
              <th>æ•°æ®åº“</th>
              <th>åˆ›å»ºæ—¶é—´</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="datasourceTableBody">
            <tr><td colspan="6" class="empty-state">åŠ è½½ä¸­...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- æ•°æ®æºç¼–è¾‘Modal -->
  <div class="modal" id="datasourceModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="datasourceModalTitle">æ·»åŠ æ•°æ®æº</h3>
        <button class="modal-close" onclick="closeDatasourceModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="dsId">
        <div class="form-group">
          <label class="form-label">åç§° *</label>
          <input type="text" class="form-input" id="dsName" placeholder="æ•°æ®æºåç§°">
        </div>
        <div class="form-group">
          <label class="form-label">ä¸»æœº *</label>
          <input type="text" class="form-input" id="dsHost" placeholder="localhost æˆ– IPåœ°å€">
        </div>
        <div class="form-group">
          <label class="form-label">ç«¯å£ *</label>
          <input type="number" class="form-input" id="dsPort" value="3306">
        </div>
        <div class="form-group">
          <label class="form-label">ç”¨æˆ·å *</label>
          <input type="text" class="form-input" id="dsUser" placeholder="æ•°æ®åº“ç”¨æˆ·å">
        </div>
        <div class="form-group">
          <label class="form-label">å¯†ç  *</label>
          <input type="password" class="form-input" id="dsPassword" placeholder="æ•°æ®åº“å¯†ç ">
        </div>
        <div class="form-group">
          <label class="form-label">æ•°æ®åº“ *</label>
          <input type="text" class="form-input" id="dsDatabase" placeholder="æ•°æ®åº“åç§°">
        </div>
        <div class="form-group">
          <label class="form-label">æœ€å°è¿æ¥æ•°</label>
          <input type="number" class="form-input" id="dsPoolMin" value="2">
        </div>
        <div class="form-group">
          <label class="form-label">æœ€å¤§è¿æ¥æ•°</label>
          <input type="number" class="form-input" id="dsPoolMax" value="10">
        </div>
        <button class="btn btn-secondary btn-sm" onclick="testDatasourceConnection()">ğŸ”Œ æµ‹è¯•è¿æ¥</button>
        <div class="result-container" id="dsTestResultContainer">
          <div class="code-block"><pre></pre></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-success" onclick="saveDatasource()">ä¿å­˜</button>
        <button class="btn btn-secondary" onclick="closeDatasourceModal()">å–æ¶ˆ</button>
      </div>
    </div>
  </div>

  <!-- åˆ†ç»„ç®¡ç†Modal -->
  <div class="modal" id="groupManagementModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">åˆ†ç»„ç®¡ç†</h3>
        <button class="modal-close" onclick="closeGroupManagementModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <button class="btn btn-primary btn-sm" onclick="openAddGroupModal()">+ æ·»åŠ åˆ†ç»„</button>
        <table class="table">
          <thead>
            <tr>
              <th>åç§°</th>
              <th>è¯´æ˜</th>
              <th>æ’åº</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="groupTableBody">
            <tr><td colspan="4" class="empty-state">åŠ è½½ä¸­...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- åˆ†ç»„ç¼–è¾‘Modal -->
  <div class="modal" id="groupModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="groupModalTitle">æ·»åŠ åˆ†ç»„</h3>
        <button class="modal-close" onclick="closeGroupModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="groupId">
        <div class="form-group">
          <label class="form-label">åˆ†ç»„åç§° *</label>
          <input type="text" class="form-input" id="groupName" placeholder="åˆ†ç»„åç§°">
        </div>
        <div class="form-group">
          <label class="form-label">è¯´æ˜</label>
          <input type="text" class="form-input" id="groupDescription" placeholder="åˆ†ç»„è¯´æ˜">
        </div>
        <div class="form-group">
          <label class="form-label">æ’åº</label>
          <input type="number" class="form-input" id="groupOrder" value="1">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-success" onclick="saveGroup()">ä¿å­˜</button>
        <button class="btn btn-secondary" onclick="closeGroupModal()">å–æ¶ˆ</button>
      </div>
    </div>
  </div>

  <script>
    // ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼Œè‡ªåŠ¨é€‚é…å½“å‰åŸŸåå’Œåè®®
    const API_BASE = window.location.origin;
    let allApis = [];
    let groups = [];
    let datasources = [];
    let currentAPI = null;
    let currentSqlTabs = [];
    let activeSqlTabIndex = 0;

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    window.addEventListener('DOMContentLoaded', async () => {
      await loadMetadata();
      await loadAPIs();
    });

    // åŠ è½½å…ƒæ•°æ®ï¼ˆåˆ†ç»„å’Œæ•°æ®æºï¼‰
    async function loadMetadata() {
      try {
        const [groupsRes, datasourcesRes] = await Promise.all([
          fetch(`${API_BASE}/admin/groups`),
          fetch(`${API_BASE}/admin/datasources`)
        ]);

        const groupsData = await groupsRes.json();
        const datasourcesData = await datasourcesRes.json();

        if (groupsData.success) {
          groups = groupsData.data || groupsData.groups || [];
          populateGroupSelect();
        }

        if (datasourcesData.success) {
          datasources = datasourcesData.data || [];
          populateDatasourceSelect();
        }

        updateStats();
      } catch (error) {
        console.error('åŠ è½½å…ƒæ•°æ®å¤±è´¥:', error);
      }
    }

    // å¡«å……åˆ†ç»„ä¸‹æ‹‰æ¡†
    function populateGroupSelect() {
      const select = document.getElementById('apiGroup');
      select.innerHTML = '<option value="">é€‰æ‹©åˆ†ç»„</option>';
      groups.forEach(group => {
        const option = document.createElement('option');
        option.value = group.id;
        option.textContent = group.name;
        select.appendChild(option);
      });
    }

    // å¡«å……æ•°æ®æºä¸‹æ‹‰æ¡†
    function populateDatasourceSelect() {
      const select = document.getElementById('apiDatasource');
      select.innerHTML = '<option value="">é€‰æ‹©æ•°æ®æº</option>';
      datasources.forEach(ds => {
        const option = document.createElement('option');
        option.value = ds.id;
        option.textContent = ds.name;
        select.appendChild(option);
      });
    }

    // åŠ è½½æ‰€æœ‰API
    async function loadAPIs() {
      try {
        const response = await fetch(`${API_BASE}/admin/apis`);
        const data = await response.json();

        if (data.success) {
          allApis = data.data || data.apis || [];
          updateStats();
          renderAPITree();
        } else {
          console.error('åŠ è½½APIå¤±è´¥:', data.message);
        }
      } catch (error) {
        console.error('åŠ è½½APIå¤±è´¥:', error);
      }
    }

    // æ›´æ–°ç»Ÿè®¡æ•°å­—
    function updateStats() {
      document.getElementById('totalApis').textContent = allApis.length;
      document.getElementById('totalGroups').textContent = groups.length;
      document.getElementById('totalDatasources').textContent = datasources.length;
    }

    // æ¸²æŸ“APIæ ‘
    function renderAPITree() {
      const treeContainer = document.getElementById('apiTree');
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();

      // è¿‡æ»¤API
      let filteredApis = allApis;
      if (searchTerm) {
        filteredApis = allApis.filter(api =>
          api.name.toLowerCase().includes(searchTerm) ||
          api.path.toLowerCase().includes(searchTerm) ||
          (api.note && api.note.toLowerCase().includes(searchTerm))
        );
      }

      // æŒ‰åˆ†ç»„åˆ†ç±»API
      const groupedAPIs = {};
      const ungroupedAPIs = [];

      filteredApis.forEach(api => {
        if (api.groupId) {
          if (!groupedAPIs[api.groupId]) {
            groupedAPIs[api.groupId] = [];
          }
          groupedAPIs[api.groupId].push(api);
        } else {
          ungroupedAPIs.push(api);
        }
      });

      let html = '';

      // æ¸²æŸ“åˆ†ç»„
      groups.forEach(group => {
        const groupAPIs = groupedAPIs[group.id] || [];
        if (searchTerm && groupAPIs.length === 0) return; // æœç´¢æ—¶éšè—ç©ºåˆ†ç»„

        html += `
          <div class="tree-group">
            <div class="group-header" onclick="toggleGroup('${group.id}')">
              <span class="group-icon">â–¼</span>
              <span class="group-name">ğŸ“ ${group.name}</span>
              <span class="group-count">${groupAPIs.length}</span>
            </div>
            <div class="group-apis expanded" id="group-${group.id}">
              ${groupAPIs.map(api => renderAPIItem(api)).join('')}
            </div>
          </div>
        `;
      });

      // æ¸²æŸ“æœªåˆ†ç»„çš„API
      if (ungroupedAPIs.length > 0) {
        html += `
          <div class="tree-group">
            <div class="group-header" onclick="toggleGroup('ungrouped')">
              <span class="group-icon">â–¼</span>
              <span class="group-name">ğŸ“‚ æœªåˆ†ç»„</span>
              <span class="group-count">${ungroupedAPIs.length}</span>
            </div>
            <div class="group-apis expanded" id="group-ungrouped">
              ${ungroupedAPIs.map(api => renderAPIItem(api)).join('')}
            </div>
          </div>
        `;
      }

      treeContainer.innerHTML = html || '<div style="padding: 20px; text-align: center; color: var(--text-secondary);">æš‚æ— API</div>';
    }

    // æ¸²æŸ“å•ä¸ªAPIé¡¹
    function renderAPIItem(api) {
      const method = 'POST';
      const isActive = currentAPI && currentAPI.id === api.id ? 'active' : '';
      return `
        <div class="api-item ${isActive}" data-id="${api.id}" onclick="selectAPI('${api.id}', event)">
          <span class="api-method ${method.toLowerCase()}">${method}</span>
          <span>${api.name}</span>
        </div>
      `;
    }

    // åˆ‡æ¢åˆ†ç»„å±•å¼€/æŠ˜å 
    function toggleGroup(groupId) {
      const groupElement = document.getElementById(`group-${groupId}`);
      if (!groupElement) return;

      const header = groupElement.previousElementSibling;

      if (groupElement.classList.contains('expanded')) {
        groupElement.classList.remove('expanded');
        header.classList.add('collapsed');
      } else {
        groupElement.classList.add('expanded');
        header.classList.remove('collapsed');
      }
    }

    // å…¨éƒ¨æŠ˜å /å±•å¼€
    function toggleAllGroups() {
      const allGroups = document.querySelectorAll('.group-apis');
      const isExpanded = Array.from(allGroups).some(g => g.classList.contains('expanded'));

      allGroups.forEach(group => {
        if (isExpanded) {
          group.classList.remove('expanded');
          group.previousElementSibling.classList.add('collapsed');
        } else {
          group.classList.add('expanded');
          group.previousElementSibling.classList.remove('collapsed');
        }
      });
    }

    // æœç´¢è¾“å…¥äº‹ä»¶
    document.getElementById('searchInput').addEventListener('input', () => {
      renderAPITree();
    });

    // é€‰æ‹©API
    async function selectAPI(apiId, event) {
      try {
        const response = await fetch(`${API_BASE}/admin/apis/${apiId}`);
        if (!response.ok) throw new Error('åŠ è½½å¤±è´¥');

        const data = await response.json();
        currentAPI = data.api || data.data;

        // æ›´æ–°é€‰ä¸­çŠ¶æ€
        document.querySelectorAll('.api-item').forEach(item => {
          item.classList.remove('active');
        });
        // é€šè¿‡apiIdæ‰¾åˆ°å¯¹åº”çš„å…ƒç´ å¹¶æ·»åŠ activeç±»
        const clickedItem = document.querySelector(`.api-item[data-id="${apiId}"]`);
        if (clickedItem) {
          clickedItem.classList.add('active');
        } else if (event && event.currentTarget) {
          event.currentTarget.classList.add('active');
        }

        // æ˜¾ç¤ºè¯¦æƒ…é¢æ¿
        document.getElementById('welcomeScreen').style.display = 'none';
        document.getElementById('detailPanel').classList.add('active');

        // å¡«å……è¡¨å•
        document.getElementById('apiId').value = currentAPI.id;
        document.getElementById('detailTitle').textContent = currentAPI.name;
        document.getElementById('detailPath').textContent = currentAPI.path;
        document.getElementById('apiName').value = currentAPI.name || '';
        document.getElementById('apiPath').value = currentAPI.path || '';
        document.getElementById('apiNote').value = currentAPI.note || '';
        document.getElementById('apiGroup').value = currentAPI.groupId || '';
        document.getElementById('apiDatasource').value = currentAPI.datasourceId || '';
        document.getElementById('apiContentType').value = currentAPI.contentType || 'application/json';
        document.getElementById('apiTransaction').checked = currentAPI.transaction === 1;

        // åŠ è½½SQLæ ‡ç­¾
        currentSqlTabs = currentAPI.sqlList && currentAPI.sqlList.length > 0 ? currentAPI.sqlList : [{
          id: generateId(),
          sqlText: ''
        }];
        activeSqlTabIndex = 0;
        renderSqlTabs();

        // åŠ è½½å‚æ•°
        if (currentAPI.params && currentAPI.params.length > 0) {
          const paramsText = currentAPI.params.map(p =>
            `${p.name}:${p.type}:${p.note || ''}`
          ).join('\n');
          document.getElementById('apiParams').value = paramsText;
        } else {
          document.getElementById('apiParams').value = '';
        }

        // åŠ è½½æµ‹è¯•å‚æ•°
        if (currentAPI.testParams && Object.keys(currentAPI.testParams).length > 0) {
          document.getElementById('apiTestParams').value = JSON.stringify(currentAPI.testParams, null, 2);
        } else {
          document.getElementById('apiTestParams').value = '';
        }

        // éšè—æµ‹è¯•ç»“æœ
        document.getElementById('testResultContainer').classList.remove('active');

      } catch (error) {
        alert('åŠ è½½ API å¤±è´¥: ' + error.message);
      }
    }

    // æ¸²æŸ“SQLæ ‡ç­¾é¡µ
    function renderSqlTabs() {
      const header = document.getElementById('sqlTabsHeader');
      const content = document.getElementById('sqlTabsContent');

      // æ¸²æŸ“æ ‡ç­¾å¤´
      header.innerHTML = `
        ${currentSqlTabs.map((sql, index) => `
          <button type="button" class="sql-tab ${index === activeSqlTabIndex ? 'active' : ''}"
                  onclick="switchSqlTab(${index})">
            SQL-${index + 1}
            ${currentSqlTabs.length > 1 ? `<span class="sql-tab-close" onclick="event.stopPropagation(); deleteSqlTab(${index})">&times;</span>` : ''}
          </button>
        `).join('')}
        <button type="button" class="sql-tab-add" onclick="addSqlTab()">+ æ–°å¢ SQL</button>
      `;

      // æ¸²æŸ“æ ‡ç­¾å†…å®¹
      content.innerHTML = currentSqlTabs.map((sql, index) => `
        <div class="sql-tab-content ${index === activeSqlTabIndex ? 'active' : ''}" id="sqlContent${index}">
          <div class="sql-info">
            SQL ID: ${sql.id || 'æ–°å»º'} | æ ‡ç­¾ ${index + 1}
          </div>
          <textarea class="form-textarea" rows="12"
                    style="width: 100%; min-height: 300px;"
                    placeholder="è¾“å…¥ SQL æŸ¥è¯¢è¯­å¥ï¼Œæ”¯æŒ MyBatis å‚æ•°ï¼š#{param}"
                    onchange="updateSqlText(${index}, this.value)">${sql.sqlText || ''}</textarea>
        </div>
      `).join('');
    }

    // åˆ‡æ¢SQLæ ‡ç­¾
    function switchSqlTab(index) {
      activeSqlTabIndex = index;
      renderSqlTabs();
    }

    // æ·»åŠ SQLæ ‡ç­¾
    function addSqlTab() {
      currentSqlTabs.push({
        id: generateId(),
        sqlText: ''
      });
      activeSqlTabIndex = currentSqlTabs.length - 1;
      renderSqlTabs();
    }

    // åˆ é™¤SQLæ ‡ç­¾
    function deleteSqlTab(index) {
      if (currentSqlTabs.length <= 1) {
        alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ª SQLï¼');
        return;
      }

      if (!confirm(`ç¡®å®šè¦åˆ é™¤ SQL-${index + 1} å—ï¼Ÿ`)) {
        return;
      }

      currentSqlTabs.splice(index, 1);
      if (activeSqlTabIndex >= currentSqlTabs.length) {
        activeSqlTabIndex = currentSqlTabs.length - 1;
      }
      renderSqlTabs();
    }

    // æ›´æ–°SQLæ–‡æœ¬
    function updateSqlText(index, text) {
      currentSqlTabs[index].sqlText = text;
    }

    // åˆ‡æ¢Tab
    function switchTab(tabName, event) {
      // æ›´æ–°TabæŒ‰é’®çŠ¶æ€
      document.querySelectorAll('.detail-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      if (event && event.currentTarget) {
        event.currentTarget.classList.add('active');
      } else {
        // å¦‚æœæ²¡æœ‰eventï¼Œé€šè¿‡tabNameæ‰¾åˆ°å¯¹åº”çš„æŒ‰é’®
        const tabs = document.querySelectorAll('.detail-tab');
        tabs.forEach(tab => {
          if (tab.textContent.includes(tabName === 'basic' ? 'åŸºæœ¬ä¿¡æ¯' :
              tabName === 'sql' ? 'SQLé…ç½®' :
              tabName === 'params' ? 'å‚æ•°' : 'æµ‹è¯•')) {
            tab.classList.add('active');
          }
        });
      }

      // æ›´æ–°Tabå†…å®¹
      document.querySelectorAll('.tab-pane').forEach(pane => {
        pane.classList.remove('active');
      });
      document.getElementById(`tab-${tabName}`).classList.add('active');
    }

    // åˆ›å»ºæ–°API
    function createNewAPI() {
      currentAPI = null;

      // æ¸…ç©ºè¡¨å•
      document.getElementById('apiId').value = '';
      document.getElementById('apiName').value = '';
      document.getElementById('apiPath').value = '';
      document.getElementById('apiNote').value = '';
      document.getElementById('apiGroup').value = '';
      document.getElementById('apiDatasource').value = '';
      document.getElementById('apiContentType').value = 'application/json';
      document.getElementById('apiTransaction').checked = false;
      document.getElementById('apiParams').value = '';
      document.getElementById('apiTestParams').value = '';

      // åˆå§‹åŒ–ä¸€ä¸ªç©ºçš„SQLæ ‡ç­¾
      currentSqlTabs = [{
        id: generateId(),
        sqlText: ''
      }];
      activeSqlTabIndex = 0;
      renderSqlTabs();

      // æ˜¾ç¤ºè¯¦æƒ…é¢æ¿
      document.getElementById('welcomeScreen').style.display = 'none';
      document.getElementById('detailPanel').classList.add('active');
      document.getElementById('detailTitle').textContent = 'æ–°å»ºAPI';
      document.getElementById('detailPath').textContent = 'æœªä¿å­˜';

      // æ¸…é™¤é€‰ä¸­çŠ¶æ€
      document.querySelectorAll('.api-item').forEach(item => {
        item.classList.remove('active');
      });

      // éšè—æµ‹è¯•ç»“æœ
      document.getElementById('testResultContainer').classList.remove('active');

      // åˆ‡æ¢åˆ°åŸºæœ¬ä¿¡æ¯Tab
      document.querySelectorAll('.detail-tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
      document.querySelector('.detail-tab').classList.add('active');
      document.getElementById('tab-basic').classList.add('active');
    }

    // ä¿å­˜API
    async function saveAPI() {
      const id = document.getElementById('apiId').value;
      const name = document.getElementById('apiName').value.trim();
      const path = document.getElementById('apiPath').value.trim();
      const note = document.getElementById('apiNote').value.trim();
      const groupId = document.getElementById('apiGroup').value;
      const datasourceId = document.getElementById('apiDatasource').value;
      const contentType = document.getElementById('apiContentType').value;
      const isTransaction = document.getElementById('apiTransaction').checked;
      const paramsText = document.getElementById('apiParams').value;
      const testParamsText = document.getElementById('apiTestParams').value;

      // éªŒè¯å¿…å¡«å­—æ®µ
      if (!name || !path || !groupId || !datasourceId) {
        alert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µï¼ˆåç§°ã€è·¯å¾„ã€åˆ†ç»„ã€æ•°æ®æºï¼‰');
        return;
      }

      // éªŒè¯è·¯å¾„æ˜¯å¦é‡å¤
      const duplicateApi = allApis.find(api => api.path === path && api.id !== id);
      if (duplicateApi) {
        alert(`âŒ è·¯å¾„é‡å¤ï¼\n\nè·¯å¾„ "${path}" å·²è¢« API "${duplicateApi.name}" ä½¿ç”¨ã€‚\n\nè¯·ä½¿ç”¨å…¶ä»–è·¯å¾„ã€‚`);
        return;
      }

      // éªŒè¯è‡³å°‘æœ‰ä¸€ä¸ªSQL
      if (currentSqlTabs.length === 0 || !currentSqlTabs[0].sqlText.trim()) {
        alert('è¯·è‡³å°‘å¡«å†™ä¸€ä¸ª SQL è¯­å¥');
        return;
      }

      // è§£æå‚æ•°
      const params = paramsText.trim() ? paramsText.split('\n').map(line => {
        const [name, type, note] = line.split(':').map(s => s.trim());
        return { name, type, note: note || '' };
      }) : [];

      // è§£ææµ‹è¯•å‚æ•°
      let testParams = {};
      if (testParamsText.trim()) {
        try {
          testParams = JSON.parse(testParamsText);
        } catch (e) {
          alert('âŒ æµ‹è¯•å‚æ•° JSON æ ¼å¼é”™è¯¯: ' + e.message);
          return;
        }
      }

      const apiData = {
        name,
        path,
        note,
        groupId,
        datasourceId,
        contentType,
        transaction: isTransaction ? 1 : 0,
        params,
        testParams,
        sqlList: currentSqlTabs.map(tab => ({
          id: tab.id,
          sqlText: tab.sqlText
        }))
      };

      try {
        const url = id ? `${API_BASE}/admin/apis/${id}` : `${API_BASE}/admin/apis`;
        const method = id ? 'PUT' : 'POST';

        const response = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(apiData)
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message || error.error || 'ä¿å­˜å¤±è´¥');
        }

        alert(id ? 'âœ… API æ›´æ–°æˆåŠŸï¼' : 'âœ… API åˆ›å»ºæˆåŠŸï¼');
        await loadAPIs();

        // å¦‚æœæ˜¯æ–°å»ºçš„ï¼Œé€‰ä¸­åˆšåˆ›å»ºçš„API
        if (!id) {
          const result = await response.json();
          if (result.data && result.data.id) {
            // ç­‰å¾…æ ‘é‡æ–°æ¸²æŸ“
            setTimeout(() => {
              const apiItem = document.querySelector(`.api-item[onclick*="${result.data.id}"]`);
              if (apiItem) apiItem.click();
            }, 100);
          }
        }
      } catch (error) {
        alert('âŒ ä¿å­˜å¤±è´¥\n\n' + error.message);
      }
    }

    // åˆ é™¤å½“å‰API
    async function deleteCurrentAPI() {
      const id = document.getElementById('apiId').value;
      const name = document.getElementById('apiName').value;

      if (!id) {
        alert('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„API');
        return;
      }

      if (!confirm(`ç¡®å®šè¦åˆ é™¤ API "${name}" å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/admin/apis/${id}`, {
          method: 'DELETE'
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'åˆ é™¤å¤±è´¥');
        }

        alert('âœ… API åˆ é™¤æˆåŠŸï¼');
        closeDetail();
        await loadAPIs();
      } catch (error) {
        alert('âŒ åˆ é™¤å¤±è´¥: ' + error.message);
      }
    }

    // å…³é—­è¯¦æƒ…é¢æ¿
    function closeDetail() {
      document.getElementById('detailPanel').classList.remove('active');
      document.getElementById('welcomeScreen').style.display = 'flex';
      document.querySelectorAll('.api-item').forEach(item => {
        item.classList.remove('active');
      });
      currentAPI = null;
    }

    // æµ‹è¯•æ‰§è¡ŒAPI
    async function testExecuteApi() {
      const id = document.getElementById('apiId').value;
      const testParamsText = document.getElementById('apiTestParams').value;
      const datasourceId = document.getElementById('apiDatasource').value;
      const isTransaction = document.getElementById('apiTransaction').checked;

      // éªŒè¯å¿…å¡«å­—æ®µ
      if (!datasourceId) {
        alert('âš ï¸ è¯·å…ˆé€‰æ‹©æ•°æ®æº');
        return;
      }

      // éªŒè¯è‡³å°‘æœ‰ä¸€ä¸ªSQL
      if (currentSqlTabs.length === 0 || !currentSqlTabs[0].sqlText.trim()) {
        alert('âš ï¸ è¯·è‡³å°‘å¡«å†™ä¸€ä¸ª SQL è¯­å¥');
        return;
      }

      // è§£ææµ‹è¯•å‚æ•°
      let testParams = {};
      if (testParamsText.trim()) {
        try {
          testParams = JSON.parse(testParamsText);
        } catch (e) {
          alert('âŒ æµ‹è¯•å‚æ•° JSON æ ¼å¼é”™è¯¯: ' + e.message);
          return;
        }
      }

      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      const resultContainer = document.getElementById('testResultContainer');
      const resultElement = document.getElementById('testResult');

      resultContainer.classList.add('active');
      resultElement.textContent = 'â³ æ­£åœ¨æ‰§è¡Œæµ‹è¯•...';
      resultElement.style.color = '';

      try {
        let response, result;

        if (id) {
          // ç¼–è¾‘æ¨¡å¼ï¼šä½¿ç”¨å·²ä¿å­˜çš„APIè¿›è¡Œæµ‹è¯•
          response = await fetch(`${API_BASE}/admin/apis/${id}/test-execute`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ testParams })
          });
        } else {
          // æ–°å¢æ¨¡å¼ï¼šä½¿ç”¨ä¸´æ—¶æµ‹è¯•æ¥å£
          response = await fetch(`${API_BASE}/admin/test-execute`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              datasourceId,
              sqlList: currentSqlTabs.map(tab => ({
                id: tab.id,
                sqlText: tab.sqlText
              })),
              testParams,
              transaction: isTransaction ? 1 : 0
            })
          });
        }

        result = await response.json();

        if (response.ok && result.success) {
          // æˆåŠŸæ‰§è¡Œ
          resultElement.style.color = '#4caf50';
          resultElement.textContent =
            `âœ… æµ‹è¯•æ‰§è¡ŒæˆåŠŸï¼\n\n` +
            `æ‰§è¡Œå‚æ•°ï¼š\n${JSON.stringify(result.executedWith, null, 2)}\n\n` +
            `è¿”å›ç»“æœï¼š\n${JSON.stringify(result.data, null, 2)}`;
        } else {
          // æ‰§è¡Œå¤±è´¥
          resultElement.style.color = '#f44336';
          resultElement.textContent =
            `âŒ æµ‹è¯•æ‰§è¡Œå¤±è´¥\n\n` +
            `é”™è¯¯ä¿¡æ¯ï¼š${result.message}\n\n` +
            (result.error ? `è¯¦ç»†é”™è¯¯ï¼š\n${result.error}` : '');
        }
      } catch (error) {
        resultElement.style.color = '#f44336';
        resultElement.textContent =
          `âŒ è¯·æ±‚å¤±è´¥\n\n` +
          `é”™è¯¯ä¿¡æ¯ï¼š${error.message}\n\n` +
          `è¯·æ£€æŸ¥ï¼š\n` +
          `1. æœåŠ¡å™¨æ˜¯å¦æ­£å¸¸è¿è¡Œ\n` +
          `2. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸\n` +
          `3. SQLè¯­å¥æ˜¯å¦æ­£ç¡®`;
      }
    }

    // ========== æ•°æ®æºç®¡ç†åŠŸèƒ½ ==========

    // æ‰“å¼€æ•°æ®æºç®¡ç†Modal
    async function manageDatasources() {
      try {
        await loadDatasourcesList();
        document.getElementById('datasourceManagementModal').classList.add('active');
      } catch (error) {
        alert('âŒ åŠ è½½æ•°æ®æºåˆ—è¡¨å¤±è´¥: ' + error.message);
      }
    }

    // å…³é—­æ•°æ®æºç®¡ç†Modal
    function closeDatasourceManagementModal() {
      document.getElementById('datasourceManagementModal').classList.remove('active');
    }

    // åŠ è½½æ•°æ®æºåˆ—è¡¨
    async function loadDatasourcesList() {
      try {
        const response = await fetch(`${API_BASE}/admin/datasources`);
        const result = await response.json();

        if (!result.success) {
          throw new Error(result.message);
        }

        const datasourceList = result.data || [];
        const tbody = document.getElementById('datasourceTableBody');

        if (datasourceList.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="empty-state">æš‚æ— æ•°æ®æºï¼Œè¯·æ·»åŠ æ–°æ•°æ®æº</td></tr>';
          return;
        }

        tbody.innerHTML = datasourceList.map(ds => `
          <tr>
            <td>${ds.name}</td>
            <td>${ds.host}</td>
            <td>${ds.port}</td>
            <td>${ds.database}</td>
            <td>${ds.createTime || '-'}</td>
            <td class="actions">
              <button class="btn btn-sm btn-primary" onclick="editDatasource('${ds.id}')">ç¼–è¾‘</button>
              <button class="btn btn-sm btn-danger" onclick="deleteDatasource('${ds.id}', '${ds.name}')">åˆ é™¤</button>
            </td>
          </tr>
        `).join('');
      } catch (error) {
        console.error('åŠ è½½æ•°æ®æºåˆ—è¡¨å¤±è´¥:', error);
        throw error;
      }
    }

    // æ‰“å¼€æ·»åŠ æ•°æ®æºModal
    function openAddDatasourceModal() {
      document.getElementById('datasourceModalTitle').textContent = 'æ·»åŠ æ–°æ•°æ®æº';
      document.getElementById('dsId').value = '';
      document.getElementById('dsName').value = '';
      document.getElementById('dsHost').value = '';
      document.getElementById('dsPort').value = '3306';
      document.getElementById('dsUser').value = '';
      document.getElementById('dsPassword').value = '';
      document.getElementById('dsDatabase').value = '';
      document.getElementById('dsPoolMin').value = '2';
      document.getElementById('dsPoolMax').value = '10';
      document.getElementById('dsTestResultContainer').classList.remove('active');

      document.getElementById('datasourceModal').classList.add('active');
    }

    // ç¼–è¾‘æ•°æ®æº
    async function editDatasource(id) {
      try {
        const response = await fetch(`${API_BASE}/admin/datasources/${id}`);
        const result = await response.json();

        if (!result.success) {
          throw new Error(result.message);
        }

        const ds = result.data;

        document.getElementById('datasourceModalTitle').textContent = 'ç¼–è¾‘æ•°æ®æº';
        document.getElementById('dsId').value = ds.id;
        document.getElementById('dsName').value = ds.name;
        document.getElementById('dsHost').value = ds.host;
        document.getElementById('dsPort').value = ds.port;
        document.getElementById('dsUser').value = ds.user;
        document.getElementById('dsPassword').value = ''; // å¯†ç ä¸å›æ˜¾
        document.getElementById('dsDatabase').value = ds.database;
        document.getElementById('dsPoolMin').value = ds.poolMin || 2;
        document.getElementById('dsPoolMax').value = ds.poolMax || 10;
        document.getElementById('dsTestResultContainer').classList.remove('active');

        document.getElementById('datasourceModal').classList.add('active');
      } catch (error) {
        alert('âŒ åŠ è½½æ•°æ®æºå¤±è´¥: ' + error.message);
      }
    }

    // å…³é—­æ•°æ®æºç¼–è¾‘Modal
    function closeDatasourceModal() {
      document.getElementById('datasourceModal').classList.remove('active');
    }

    // æµ‹è¯•æ•°æ®æºè¿æ¥
    async function testDatasourceConnection() {
      const host = document.getElementById('dsHost').value.trim();
      const port = parseInt(document.getElementById('dsPort').value);
      const user = document.getElementById('dsUser').value.trim();
      const password = document.getElementById('dsPassword').value.trim();
      const database = document.getElementById('dsDatabase').value.trim();

      if (!host || !user || !password || !database) {
        alert('âš ï¸ è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ');
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/admin/datasources/test`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ host, port, user, password, database })
        });

        const result = await response.json();
        const container = document.getElementById('dsTestResultContainer');
        const resultElement = container.querySelector('pre');

        container.classList.add('active');

        if (result.success) {
          resultElement.style.color = '#4caf50';
          resultElement.textContent =
            `âœ… ${result.message}\n\n` +
            `æ•°æ®åº“ï¼š${result.data.database}\n` +
            `ä¸»æœºï¼š${result.data.host}`;
        } else {
          resultElement.style.color = '#f44336';
          resultElement.textContent =
            `âŒ ${result.message}\n\n` +
            `é”™è¯¯ä»£ç ï¼š${result.error || 'æœªçŸ¥'}`;
        }
      } catch (error) {
        const container = document.getElementById('dsTestResultContainer');
        const resultElement = container.querySelector('pre');
        container.classList.add('active');
        resultElement.style.color = '#f44336';
        resultElement.textContent = `âŒ æµ‹è¯•è¿æ¥å¤±è´¥\n\né”™è¯¯ï¼š${error.message}`;
      }
    }

    // ä¿å­˜æ•°æ®æº
    async function saveDatasource() {
      const id = document.getElementById('dsId').value;
      const name = document.getElementById('dsName').value.trim();
      const host = document.getElementById('dsHost').value.trim();
      const port = parseInt(document.getElementById('dsPort').value);
      const user = document.getElementById('dsUser').value.trim();
      const password = document.getElementById('dsPassword').value.trim();
      const database = document.getElementById('dsDatabase').value.trim();
      const poolMin = parseInt(document.getElementById('dsPoolMin').value);
      const poolMax = parseInt(document.getElementById('dsPoolMax').value);

      if (!name || !host || !user || !database) {
        alert('âš ï¸ è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ');
        return;
      }

      if (!password && !id) {
        alert('âš ï¸ è¯·è¾“å…¥å¯†ç ');
        return;
      }

      try {
        const dsData = { name, host, port, user, database, poolMin, poolMax };

        // åªæœ‰åœ¨åˆ›å»ºæ–°æ•°æ®æºæˆ–ä¿®æ”¹å¯†ç æ—¶æ‰åŒ…å«å¯†ç 
        if (password) {
          dsData.password = password;
        }

        const url = id ? `${API_BASE}/admin/datasources/${id}` : `${API_BASE}/admin/datasources`;
        const method = id ? 'PUT' : 'POST';

        const response = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(dsData)
        });

        const result = await response.json();

        if (!result.success) {
          throw new Error(result.message);
        }

        alert(id ? 'âœ… æ•°æ®æºæ›´æ–°æˆåŠŸï¼' : 'âœ… æ•°æ®æºåˆ›å»ºæˆåŠŸï¼');
        closeDatasourceModal();
        await loadDatasourcesList();
        await loadMetadata(); // é‡æ–°åŠ è½½å…ƒæ•°æ®ï¼Œæ›´æ–°æ•°æ®æºä¸‹æ‹‰åˆ—è¡¨
      } catch (error) {
        alert('âŒ ä¿å­˜å¤±è´¥\n\n' + error.message);
      }
    }

    // åˆ é™¤æ•°æ®æº
    async function deleteDatasource(id, name) {
      if (!confirm(`ç¡®å®šè¦åˆ é™¤æ•°æ®æº "${name}" å—ï¼Ÿ\n\nâš ï¸ è­¦å‘Šï¼šåˆ é™¤åï¼Œä½¿ç”¨è¯¥æ•°æ®æºçš„APIå°†æ— æ³•æ­£å¸¸å·¥ä½œï¼\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/admin/datasources/${id}`, {
          method: 'DELETE'
        });

        const result = await response.json();

        if (!result.success) {
          throw new Error(result.message);
        }

        alert('âœ… æ•°æ®æºåˆ é™¤æˆåŠŸï¼');
        await loadDatasourcesList();
        await loadMetadata(); // é‡æ–°åŠ è½½å…ƒæ•°æ®
      } catch (error) {
        alert('âŒ åˆ é™¤å¤±è´¥: ' + error.message);
      }
    }

    // ========== åˆ†ç»„ç®¡ç†åŠŸèƒ½ ==========

    // æ‰“å¼€åˆ†ç»„ç®¡ç†Modal
    async function manageGroups() {
      try {
        await loadGroupsList();
        document.getElementById('groupManagementModal').classList.add('active');
      } catch (error) {
        alert('âŒ åŠ è½½åˆ†ç»„åˆ—è¡¨å¤±è´¥: ' + error.message);
      }
    }

    // å…³é—­åˆ†ç»„ç®¡ç†Modal
    function closeGroupManagementModal() {
      document.getElementById('groupManagementModal').classList.remove('active');
    }

    // åŠ è½½åˆ†ç»„åˆ—è¡¨
    async function loadGroupsList() {
      try {
        const response = await fetch(`${API_BASE}/admin/groups`);
        const result = await response.json();

        if (!result.success) {
          throw new Error(result.message);
        }

        groups = result.data || result.groups || [];
        renderGroupTable();
      } catch (error) {
        console.error('åŠ è½½åˆ†ç»„åˆ—è¡¨å¤±è´¥:', error);
        throw error;
      }
    }

    // æ¸²æŸ“åˆ†ç»„è¡¨æ ¼
    function renderGroupTable() {
      const tbody = document.getElementById('groupTableBody');

      if (!groups || groups.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="empty-state">æš‚æ— åˆ†ç»„</td></tr>';
        return;
      }

      tbody.innerHTML = groups.map(group => `
        <tr>
          <td>${group.name}</td>
          <td>${group.description || '-'}</td>
          <td>${group.order || '-'}</td>
          <td>
            <button class="btn btn-sm btn-primary" onclick="openEditGroupModal('${group.id}')">ç¼–è¾‘</button>
            <button class="btn btn-sm btn-danger" onclick="deleteGroup('${group.id}')">åˆ é™¤</button>
          </td>
        </tr>
      `).join('');
    }

    // æ‰“å¼€æ·»åŠ åˆ†ç»„Modal
    function openAddGroupModal() {
      document.getElementById('groupModalTitle').textContent = 'æ·»åŠ æ–°åˆ†ç»„';
      document.getElementById('groupId').value = '';
      document.getElementById('groupName').value = '';
      document.getElementById('groupDescription').value = '';
      document.getElementById('groupOrder').value = (groups.length + 1).toString();
      document.getElementById('groupModal').classList.add('active');
    }

    // æ‰“å¼€ç¼–è¾‘åˆ†ç»„Modal
    function openEditGroupModal(groupId) {
      const group = groups.find(g => g.id === groupId);
      if (!group) {
        alert('âŒ åˆ†ç»„ä¸å­˜åœ¨');
        return;
      }

      document.getElementById('groupModalTitle').textContent = 'ç¼–è¾‘åˆ†ç»„';
      document.getElementById('groupId').value = group.id;
      document.getElementById('groupName').value = group.name;
      document.getElementById('groupDescription').value = group.description || '';
      document.getElementById('groupOrder').value = group.order || 1;
      document.getElementById('groupModal').classList.add('active');
    }

    // å…³é—­åˆ†ç»„ç¼–è¾‘Modal
    function closeGroupModal() {
      document.getElementById('groupModal').classList.remove('active');
    }

    // ä¿å­˜åˆ†ç»„
    async function saveGroup() {
      const groupId = document.getElementById('groupId').value;
      const name = document.getElementById('groupName').value.trim();
      const description = document.getElementById('groupDescription').value.trim();
      const order = parseInt(document.getElementById('groupOrder').value) || 1;

      if (!name) {
        alert('âš ï¸ è¯·è¾“å…¥åˆ†ç»„åç§°');
        return;
      }

      try {
        const url = groupId
          ? `${API_BASE}/admin/groups/${groupId}`
          : `${API_BASE}/admin/groups`;

        const method = groupId ? 'PUT' : 'POST';

        const response = await fetch(url, {
          method: method,
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ name, description, order })
        });

        const result = await response.json();

        if (!result.success) {
          throw new Error(result.message);
        }

        alert(`âœ… åˆ†ç»„${groupId ? 'æ›´æ–°' : 'åˆ›å»º'}æˆåŠŸï¼`);
        closeGroupModal();
        await loadGroupsList();
        await loadMetadata(); // é‡æ–°åŠ è½½å…ƒæ•°æ®ï¼Œæ›´æ–°ç»Ÿè®¡å’Œä¸‹æ‹‰æ¡†
        await loadAPIs(); // é‡æ–°åŠ è½½APIåˆ—è¡¨
      } catch (error) {
        alert(`âŒ ä¿å­˜å¤±è´¥: ${error.message}`);
      }
    }

    // åˆ é™¤åˆ†ç»„
    async function deleteGroup(groupId) {
      const group = groups.find(g => g.id === groupId);
      if (!group) {
        alert('âŒ åˆ†ç»„ä¸å­˜åœ¨');
        return;
      }

      // æ£€æŸ¥æ˜¯å¦æœ‰APIä½¿ç”¨æ­¤åˆ†ç»„
      const apisInGroup = allApis.filter(api => api.groupId === groupId);
      if (apisInGroup.length > 0) {
        if (!confirm(`âš ï¸ è¯¥åˆ†ç»„ä¸‹æœ‰ ${apisInGroup.length} ä¸ªAPIï¼Œåˆ é™¤åè¿™äº›APIå°†å˜ä¸ºæ— åˆ†ç»„çŠ¶æ€ã€‚\nç¡®å®šè¦åˆ é™¤å—ï¼Ÿ`)) {
          return;
        }
      } else {
        if (!confirm(`ç¡®å®šè¦åˆ é™¤åˆ†ç»„ "${group.name}" å—ï¼Ÿ`)) {
          return;
        }
      }

      try {
        const response = await fetch(`${API_BASE}/admin/groups/${groupId}`, {
          method: 'DELETE'
        });

        const result = await response.json();

        if (!result.success) {
          throw new Error(result.message);
        }

        alert('âœ… åˆ†ç»„åˆ é™¤æˆåŠŸï¼');
        await loadGroupsList();
        await loadMetadata(); // é‡æ–°åŠ è½½å…ƒæ•°æ®
        await loadAPIs(); // é‡æ–°åŠ è½½APIåˆ—è¡¨
      } catch (error) {
        alert('âŒ åˆ é™¤å¤±è´¥: ' + error.message);
      }
    }

    // åˆ·æ–°æ•°æ®
    async function refreshData() {
      await loadMetadata();
      await loadAPIs();
    }

    // çƒ­åŠ è½½é…ç½®ï¼ˆæ— éœ€é‡å¯æœåŠ¡å™¨ï¼‰
    async function reloadConfig() {
      try {
        const response = await fetch(`${API_BASE}/admin/restart`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        const result = await response.json();

        if (result.success) {
          showNotification('âœ… ' + result.message, 'success');
          // åˆ·æ–°é¡µé¢æ•°æ®
          await refreshData();
        } else {
          showNotification('âŒ çƒ­åŠ è½½å¤±è´¥: ' + result.message, 'error');
        }
      } catch (error) {
        console.error('çƒ­åŠ è½½å¤±è´¥:', error);
        showNotification('âŒ çƒ­åŠ è½½å¤±è´¥: ' + error.message, 'error');
      }
    }

    // ç”ŸæˆéšæœºID
    function generateId() {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      let id = '';
      for (let i = 0; i < 8; i++) {
        id += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return id;
    }

    // ç‚¹å‡»Modalå¤–éƒ¨å…³é—­
    document.getElementById('datasourceManagementModal').addEventListener('click', (e) => {
      if (e.target.id === 'datasourceManagementModal') {
        closeDatasourceManagementModal();
      }
    });

    document.getElementById('datasourceModal').addEventListener('click', (e) => {
      if (e.target.id === 'datasourceModal') {
        closeDatasourceModal();
      }
    });

    document.getElementById('groupManagementModal').addEventListener('click', (e) => {
      if (e.target.id === 'groupManagementModal') {
        closeGroupManagementModal();
      }
    });

    document.getElementById('groupModal').addEventListener('click', (e) => {
      if (e.target.id === 'groupModal') {
        closeGroupModal();
      }
    });
  </script>
</body>
</html>
