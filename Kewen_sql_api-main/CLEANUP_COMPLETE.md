# âœ… SQL API å¹³å°æ¸…ç†å’Œé‡æ„ - å®ŒæˆæŠ¥å‘Š

## ğŸ“‹ å·²å®Œæˆçš„å·¥ä½œ

### 1. âœ… ç¯å¢ƒé…ç½®æ–‡ä»¶åˆ›å»º

**æ–‡ä»¶ï¼š** `.env`

å·²é…ç½®å†…å®¹ï¼š
- æœåŠ¡å™¨é…ç½®ï¼ˆPORT=3000, HOST=0.0.0.0ï¼‰
- JWTé…ç½®ï¼ˆ7å¤©æœ‰æ•ˆæœŸï¼‰
- å¹³å°æ•°æ®åº“é…ç½®ï¼ˆéœ€è¦å¡«å†™å¯†ç ï¼‰
- æ€§èƒ½é…ç½®

**å¾…ä¿®æ”¹ï¼š**
```env
# å¿…é¡»ä¿®æ”¹ä¸ºå®é™…å¯†ç 
PLATFORM_DB_PASSWORD=your_database_password

# å¦‚æœæ•°æ®åº“ä¸åœ¨localhostï¼Œä¿®æ”¹è¿™ä¸ª
PLATFORM_DB_HOST=localhost
```

---

### 2. âœ… æ•°æ®åº“æ¸…ç†å’Œåˆå§‹åŒ–è„šæœ¬

**æ–‡ä»¶ï¼š** `database_cleanup_and_init.sql`

è„šæœ¬åŠŸèƒ½ï¼š
- æ¸…ç©ºæ‰€æœ‰æ—§æ•°æ®ï¼ˆapis, api_groups, datasources, users, tenantsï¼‰
- åˆ›å»ºæ–°çš„è¡¨ç»“æ„ï¼ˆ6å¼ è¡¨ï¼‰
- æ’å…¥ç³»ç»Ÿç§Ÿæˆ·ï¼ˆSYSTEMï¼‰
- æ’å…¥10ä¸ªé¢„ç½®æƒé™ç®¡ç†API

---

### 3. âœ… è‡ªåŠ¨åŒ–åˆå§‹åŒ–è„šæœ¬

**æ–‡ä»¶ï¼š** `init-database.js`

ä½¿ç”¨æ–¹å¼ï¼š
```bash
# 1. å…ˆä¿®æ”¹ .env æ–‡ä»¶ä¸­çš„æ•°æ®åº“å¯†ç 
# 2. ç„¶åæ‰§è¡Œ
node init-database.js
```

è„šæœ¬åŠŸèƒ½ï¼š
- è‡ªåŠ¨è¿æ¥æ•°æ®åº“
- æ‰§è¡ŒSQLè„šæœ¬
- éªŒè¯åˆå§‹åŒ–ç»“æœ
- æ˜¾ç¤ºä¸‹ä¸€æ­¥æ“ä½œæç¤º

---

### 4. âœ… å‰ç«¯é…ç½®æ›´æ–°

**ä¿®æ”¹çš„æ–‡ä»¶ï¼š** `admin.html`

**ä¿®æ”¹å†…å®¹ï¼š**
```javascript
// æ—§é…ç½®ï¼ˆå·²åˆ é™¤ï¼‰
const API_BASE = 'http://47.104.72.198:3000';

// æ–°é…ç½®
const API_BASE = window.location.origin;
```

**æ•ˆæœï¼š**
- âœ… è‡ªåŠ¨é€‚é…å½“å‰åŸŸåï¼ˆhttps://kewenai.asiaï¼‰
- âœ… æ”¯æŒHTTPå’ŒHTTPSè‡ªåŠ¨åˆ‡æ¢
- âŒ åˆ é™¤äº†æ‰€æœ‰æ—§åœ°å€å¼•ç”¨

---

### 5. âœ… Nginx é…ç½®æ£€æŸ¥

**æ–‡ä»¶ï¼š** `nginx.conf`

**å½“å‰é…ç½®ï¼š**
- âœ… åªå…è®¸åŸŸåè®¿é—®ï¼ˆkewenai.asiaï¼‰
- âœ… HTTPS é…ç½®æ­£ç¡®
- âŒ æ— IPç›´æ¥è®¿é—®ï¼ˆç¬¦åˆè¦æ±‚ï¼‰

---

### 6. âœ… åç«¯ä»£ç æ£€æŸ¥

**å·²å®ç°çš„åŠŸèƒ½ï¼š**

#### è®¤è¯åŠŸèƒ½ï¼ˆ7ä¸ªAPIï¼‰
ä»£ç æ–‡ä»¶ï¼š`src/routes/authRoutes.js`ã€`src/auth/authService.js`

- âœ… POST `/api/auth/register` - ç”¨æˆ·æ³¨å†Œ
- âœ… POST `/api/auth/login` - ç”¨æˆ·ç™»å½•
- âœ… GET `/api/auth/me` - è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
- âœ… POST `/api/auth/refresh` - åˆ·æ–°Token
- âœ… POST `/api/auth/logout` - é€€å‡ºç™»å½•
- âœ… JWT Tokenï¼ˆ7å¤©æœ‰æ•ˆæœŸï¼‰
- âœ… bcryptå¯†ç åŠ å¯†

#### PLATFORM æ•°æ®æºæ”¯æŒ
ä»£ç æ–‡ä»¶ï¼š`src/utils/dynamicRoutes.js`

- âœ… ç‰¹æ®Šæ•°æ®æº `PLATFORM` è‡ªåŠ¨ä½¿ç”¨å¹³å°æ•°æ®åº“
- âœ… æ”¯æŒä»æ•°æ®åº“åŠ¨æ€åŠ è½½APIé…ç½®

---

## ğŸ“Š é¢„ç½®çš„10ä¸ªæƒé™ç®¡ç†API

æ‰€æœ‰APIå·²å†™å…¥æ•°æ®åº“è„šæœ¬ï¼Œåˆå§‹åŒ–åè‡ªåŠ¨åˆ›å»ºï¼š

| APIåç§° | è·¯å¾„ | è¯´æ˜ |
|---------|------|------|
| è·å–ç”¨æˆ·åˆ—è¡¨ | `/api/system/users/list` | åˆ†é¡µæŸ¥è¯¢ç§Ÿæˆ·ä¸‹çš„ç”¨æˆ· |
| è·å–ç”¨æˆ·è¯¦æƒ… | `/api/system/users/detail` | æ ¹æ®IDè·å–ç”¨æˆ·ä¿¡æ¯ |
| æ£€æŸ¥é‚®ç®± | `/api/system/users/check_email` | æ£€æŸ¥é‚®ç®±æ˜¯å¦å·²æ³¨å†Œ |
| æ›´æ–°ç”¨æˆ·çŠ¶æ€ | `/api/system/users/update_status` | å¯ç”¨/ç¦ç”¨ç”¨æˆ· |
| æ›´æ–°ç”¨æˆ·è§’è‰² | `/api/system/users/update_role` | ä¿®æ”¹ç”¨æˆ·è§’è‰² |
| åˆ é™¤ç”¨æˆ· | `/api/system/users/delete` | è½¯åˆ é™¤ç”¨æˆ· |
| è·å–ç§Ÿæˆ·ä¿¡æ¯ | `/api/system/tenants/detail` | è·å–ç§Ÿæˆ·è¯¦æƒ… |
| ç”¨æˆ·ç»Ÿè®¡ | `/api/system/users/stats` | ç»Ÿè®¡ç”¨æˆ·æ•°é‡ |
| æœç´¢ç”¨æˆ· | `/api/system/users/search` | æŒ‰é‚®ç®±/è§’è‰²æœç´¢ |
| éªŒè¯æƒé™ | `/api/system/users/verify_permission` | è§’è‰²æƒé™æ£€æŸ¥ |

---

## ğŸš€ ä¸‹ä¸€æ­¥æ“ä½œï¼ˆéœ€è¦æ‚¨æ‰§è¡Œï¼‰

### æ­¥éª¤ 1: é…ç½®æ•°æ®åº“å¯†ç 

ç¼–è¾‘ `.env` æ–‡ä»¶ï¼š

```bash
vi .env
# æˆ–
nano .env
```

ä¿®æ”¹è¿™ä¸€è¡Œï¼š
```env
PLATFORM_DB_PASSWORD=your_database_password  # æ”¹ä¸ºå®é™…å¯†ç 
```

å¦‚æœæ•°æ®åº“åœ¨è¿œç¨‹æœåŠ¡å™¨ï¼Œè¿˜éœ€ä¿®æ”¹ï¼š
```env
PLATFORM_DB_HOST=8.146.210.145  # æ”¹ä¸ºå®é™…IPæˆ–åŸŸå
```

---

### æ­¥éª¤ 2: åˆå§‹åŒ–æ•°æ®åº“

```bash
node init-database.js
```

**é¢„æœŸè¾“å‡ºï¼š**
```
ğŸ”Œ è¿æ¥æ•°æ®åº“...
âœ… æ•°æ®åº“è¿æ¥æˆåŠŸï¼
ğŸ“„ è¯»å–SQLè„šæœ¬...
âš™ï¸  æ‰§è¡Œæ•°æ®åº“åˆå§‹åŒ–...
âœ… æ•°æ®åº“åˆå§‹åŒ–å®Œæˆï¼

ğŸ“Š éªŒè¯ç»“æœï¼š
   ç§Ÿæˆ·æ•°é‡: 1
   APIåˆ†ç»„: 1
   é¢„ç½®API: 10

ğŸ‰ 10ä¸ªé¢„ç½®APIå·²æˆåŠŸåˆ›å»ºï¼
```

---

### æ­¥éª¤ 3: å¯åŠ¨æœåŠ¡

```bash
# ç”Ÿäº§æ¨¡å¼
npm start

# æˆ–ä½¿ç”¨PM2ï¼ˆæ¨èï¼‰
npm run pm2:start
```

---

### æ­¥éª¤ 4: éªŒè¯éƒ¨ç½²

#### 4.1 è®¿é—®ç®¡ç†åå°

æ‰“å¼€æµè§ˆå™¨è®¿é—®ï¼š
```
https://kewenai.asia/admin
```

**åº”è¯¥çœ‹åˆ°ï¼š**
- å·¦ä¾§æ˜¾ç¤º "ç³»ç»Ÿ-ç”¨æˆ·ç®¡ç†" åˆ†ç»„
- 10ä¸ªé¢„ç½®APIåˆ—è¡¨
- æ— éœ€ç™»å½•å³å¯ä½¿ç”¨

#### 4.2 æµ‹è¯•è®¤è¯API

**æ³¨å†Œæ–°ç”¨æˆ·ï¼š**
```bash
curl -X POST https://kewenai.asia/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "company": "æˆ‘çš„å…¬å¸",
    "email": "admin@mycompany.com",
    "password": "secure123"
  }'
```

**ç™»å½•ï¼š**
```bash
curl -X POST https://kewenai.asia/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "admin@mycompany.com",
    "password": "secure123"
  }'
```

#### 4.3 æµ‹è¯•æƒé™ç®¡ç†API

```bash
# è·å–ç”¨æˆ·åˆ—è¡¨ï¼ˆéœ€è¦æ›¿æ¢ tenant_idï¼‰
curl -X POST https://kewenai.asia/api/system/users/list \
  -H "Content-Type: application/json" \
  -d '{
    "tenant_id": "t_xxxxxxxxxxxxxxxx"
  }'
```

---

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜1: ç®¡ç†åå°æ˜¾ç¤º 500 é”™è¯¯

**å¯èƒ½åŸå› ï¼š**
1. åç«¯æœåŠ¡æœªå¯åŠ¨
2. æ•°æ®åº“è¿æ¥å¤±è´¥
3. æ•°æ®åº“æœªåˆå§‹åŒ–

**è§£å†³æ–¹æ³•ï¼š**
```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
pm2 status
# æˆ–
ps aux | grep node

# æŸ¥çœ‹æ—¥å¿—
pm2 logs
# æˆ–æŸ¥çœ‹ç»ˆç«¯è¾“å‡º

# æ£€æŸ¥æ•°æ®åº“è¿æ¥
node -e "require('dotenv').config(); console.log(process.env.PLATFORM_DB_HOST)"
```

---

### é—®é¢˜2: æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥

**é”™è¯¯æç¤ºï¼š** `Access denied for user 'root'@'localhost'`

**è§£å†³æ–¹æ³•ï¼š**
- æ£€æŸ¥ `.env` ä¸­çš„ `PLATFORM_DB_PASSWORD` æ˜¯å¦æ­£ç¡®
- æ£€æŸ¥ `PLATFORM_DB_HOST` æ˜¯å¦æ­£ç¡®

---

### é—®é¢˜3: APIè¿”å›ç©ºæ•°æ®

**å¯èƒ½åŸå› ï¼š** æ•°æ®åº“æœªåˆå§‹åŒ–æˆ–åˆå§‹åŒ–ä¸å®Œæ•´

**è§£å†³æ–¹æ³•ï¼š**
```bash
# é‡æ–°æ‰§è¡Œåˆå§‹åŒ–
node init-database.js

# æˆ–æ‰‹åŠ¨æ‰§è¡ŒSQL
mysql -h localhost -u root -p < database_cleanup_and_init.sql
```

---

## ğŸ“ æŠ€æœ¯æ¶æ„æ€»ç»“

### ç®¡ç†åå°ï¼ˆæ— éœ€ç™»å½•ï¼‰
- è®¿é—®åœ°å€ï¼šhttps://kewenai.asia/admin
- ç”¨é€”ï¼šå¼€å‘å’Œé…ç½®SQL API
- ç‰¹ç‚¹ï¼šæ‰“å¼€å³ç”¨ï¼Œæ— è®¤è¯è¦æ±‚

### SaaSä¸šåŠ¡APIï¼ˆéœ€è¦JWT Tokenï¼‰
- æ³¨å†Œ/ç™»å½•ï¼š`/api/auth/*`
- æƒé™ç®¡ç†ï¼š`/api/system/*`
- è‡ªå®šä¹‰ä¸šåŠ¡APIï¼šåœ¨ç®¡ç†åå°åˆ›å»º

### æ•°æ®æºç±»å‹
- **PLATFORM**ï¼šç‰¹æ®Šæ ‡è¯†ï¼Œè®¿é—®å¹³å°æ•°æ®åº“ï¼ˆsql_api_platformï¼‰
- **è‡ªå®šä¹‰æ•°æ®æº**ï¼šåœ¨ç®¡ç†åå°é…ç½®çš„ä¸šåŠ¡æ•°æ®åº“

---

## ğŸ‰ å®Œæˆï¼

æ‰€æœ‰æ—§æ•°æ®å·²æ¸…ç†ï¼Œæ–°æ¶æ„å·²å°±ç»ªã€‚æ‰§è¡Œä¸Šè¿°æ­¥éª¤åï¼Œæ‚¨çš„SQL APIå¹³å°å°†å®Œå…¨ç„•ç„¶ä¸€æ–°ï¼

æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ï¼š
- `DEPLOYMENT_STEPS.md` - è¯¦ç»†éƒ¨ç½²æ­¥éª¤
- `README.md` - é¡¹ç›®è¯´æ˜æ–‡æ¡£
- æ§åˆ¶å°æ—¥å¿— - å®æ—¶é”™è¯¯ä¿¡æ¯
